<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flamingo Leg Band Annotation Tool</title>
    <!-- 引入SheetJS库用于导出Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            padding: 10px;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 95vh;
        }

        .image-section {
            flex: 2;
            padding: 10px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .control-section {
            flex: 1;
            padding: 10px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .upload-area {
            border: 2px dashed #aaa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
            background: #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-area:hover {
            background: #e0e0e0;
        }

        .image-container {
            position: relative;
            margin-top: 10px;
            border: 1px solid #ddd;
            overflow: hidden;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        #annotation-image {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        .placeholder-text {
            color: #888;
            text-align: center;
            padding: 20px;
        }

        .type-selector {
            display: flex;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .type-btn {
            flex: 1;
            padding: 10px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        #great-btn {
            background: #FF0000; /* Red */
        }

        #american-btn {
            background: #0000FF; /* Blue */
        }

        #chilean-btn {
            background: #FFFF00; /* Yellow */
            color: black; /* Black text on yellow background */
        }

        /* Unified active state for all buttons */
        .type-btn.active, .color-btn.active {
            border: 3px solid #000 !important;
            box-shadow: 0 0 10px 3px rgba(255, 255, 0, 0.8) !important;
            transform: scale(1.1);
        }

        /* Active effect for light-colored buttons */
        .color-btn.active[data-color="#FFFFFF"],
        .color-btn.active[data-color="#FFFF00"],
        .color-btn.active[data-color="#00FFFF"],
        .color-btn.active[data-color="#FFD700"],
        .color-btn.active[data-color="#FF69B4"],
        .color-btn.active[data-color="#00CED1"],
        .color-btn.active[data-color="#7CFC00"] {
            box-shadow: 0 0 10px 3px rgba(0, 0, 0, 0.6) !important;
        }

        .color-section {
            margin-bottom: 15px;
        }

        .color-section h3 {
            margin-bottom: 5px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-btn {
            height: 30px;
            border: 2px solid #ddd;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        /* Bold effect for selected state */
        .color-btn.active {
            border-width: 4px !important;
            font-weight: bold;
        }

        .counter-display {
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: #eee;
            border-radius: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .export-btn {
            background: #6c5ce7;
            color: white;
        }

        .export-btn:hover {
            background: #5b4cd8;
        }

        .export-excel-btn {
            background: #2ecc71;
            color: white;
        }

        .export-excel-btn:hover {
            background: #27ae60;
        }

        .clear-btn {
            background: #ff4757;
            color: white;
        }

        .clear-btn:hover {
            background: #e63c4a;
        }

        .annotations-panel {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            background: white;
        }

        .annotations-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .annotations-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .annotation-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .annotation-item:hover {
            background: #e9ecef;
        }

        .annotation-great {
            border-left: 4px solid #FF0000;
        }

        .annotation-american {
            border-left: 4px solid #0000FF;
        }

        .annotation-chilean {
            border-left: 4px solid #FFFF00;
        }

        .annotation-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.7);
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }

        .annotation-info {
            font-size: 0.9rem;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .delete-btn:hover {
            color: #ff4757;
            transform: scale(1.2);
        }

        .color-info {
            display: flex;
            gap: 5px;
        }

        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #888;
        }
    </style>
</head>
<body>
<div class="container">
    <section class="image-section">
        <div class="upload-area" id="upload-area">
            <p>Click or drag image here to upload</p>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
        </div>

        <div class="image-container">
            <img id="annotation-image" alt="Uploaded Image">
            <p class="placeholder-text" id="placeholder">Please upload an image to start annotation</p>
        </div>
    </section>

    <section class="control-section">
        <h3>Flamingo Type</h3>
        <div class="type-selector">
            <button class="type-btn active" id="great-btn">Great</button>
            <button class="type-btn" id="american-btn">American</button>
            <button class="type-btn" id="chilean-btn">Chilean</button>
        </div>

        <div class="color-section">
            <h3>Left Leg Color</h3>
            <div class="color-palette" id="left-color-palette">
                <!-- Left leg color buttons will be generated dynamically by JS -->
            </div>
        </div>

        <div class="color-section">
            <h3>Right Leg Color</h3>
            <div class="color-palette" id="right-color-palette">
                <!-- Right leg color buttons will be generated dynamically by JS -->
            </div>
        </div>

        <div class="counter-display">
            Annotation Count: <span id="counter">0</span>
        </div>

        <div class="button-group">
            <button class="action-btn export-btn" id="export-btn">Export Annotations (JSON)</button>
            <button class="action-btn export-excel-btn" id="export-excel-btn">Export to Excel</button>
            <button class="action-btn clear-btn" id="clear-btn">Clear All Annotations</button>
        </div>

        <div class="annotations-panel">
            <div class="annotations-header">
                <h3>Annotation List</h3>
                <span>ID-Type</span>
            </div>
            <div class="annotations-list" id="annotations-list">
                <!-- Annotation list will be generated dynamically by JS -->
            </div>
        </div>
    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Element references
        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const annotationImage = document.getElementById('annotation-image');
        const placeholder = document.getElementById('placeholder');
        const imageContainer = document.querySelector('.image-container');
        const greatBtn = document.getElementById('great-btn');
        const americanBtn = document.getElementById('american-btn');
        const chileanBtn = document.getElementById('chilean-btn');
        const leftColorPalette = document.getElementById('left-color-palette');
        const rightColorPalette = document.getElementById('right-color-palette');
        const counter = document.getElementById('counter');
        const exportBtn = document.getElementById('export-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const clearBtn = document.getElementById('clear-btn');
        const annotationsList = document.getElementById('annotations-list');

        // State variables
        let currentType = 'great';
        let leftColor = '#FF0000'; // Default left leg color
        let rightColor = '#0000FF'; // Default right leg color
        let annotations = [];
        let nextId = 1;

        // 22 predefined colors (including white)
        const colorOptions = [
            '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
            '#FFA500', '#808080',
        ];

        // Initialize left leg color picker
        colorOptions.forEach(color => {
            const btn = document.createElement('button');
            btn.className = 'color-btn';
            btn.style.backgroundColor = color;
            btn.dataset.color = color;

            // Add border for light colors to make them visible
            if (color === '#FFFFFF' || color === '#FFFF00' || color === '#00FFFF' ||
                color === '#FFD700' || color === '#FF69B4' || color === '#00CED1' ||
                color === '#7CFC00') {
                btn.style.borderColor = '#666';
            }

            if (color === leftColor) {
                btn.classList.add('active');
            }

            btn.addEventListener('click', function () {
                document.querySelectorAll('#left-color-palette .color-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.transform = 'scale(1)';
                });
                btn.classList.add('active');
                leftColor = color;
            });

            // Add hover effect
            btn.addEventListener('mouseenter', function () {
                if (!btn.classList.contains('active')) {
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
                }
            });

            btn.addEventListener('mouseleave', function () {
                if (!btn.classList.contains('active')) {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = 'none';
                }
            });

            leftColorPalette.appendChild(btn);
        });

        // Initialize right leg color picker
        colorOptions.forEach(color => {
            const btn = document.createElement('button');
            btn.className = 'color-btn';
            btn.style.backgroundColor = color;
            btn.dataset.color = color;

            // Add border for light colors to make them visible
            if (color === '#FFFFFF' || color === '#FFFF00' || color === '#00FFFF' ||
                color === '#FFD700' || color === '#FF69B4' || color === '#00CED1' ||
                color === '#7CFC00') {
                btn.style.borderColor = '#666';
            }

            if (color === rightColor) {
                btn.classList.add('active');
            }

            btn.addEventListener('click', function () {
                document.querySelectorAll('#right-color-palette .color-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.transform = 'scale(1)';
                });
                btn.classList.add('active');
                rightColor = color;
            });

            // Add hover effect
            btn.addEventListener('mouseenter', function () {
                if (!btn.classList.contains('active')) {
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
                }
            });

            btn.addEventListener('mouseleave', function () {
                if (!btn.classList.contains('active')) {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = 'none';
                }
            });

            rightColorPalette.appendChild(btn);
        });

        // Upload area click event
        uploadArea.addEventListener('click', function () {
            imageUpload.click();
        });

        // File selection change event
        imageUpload.addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();

                reader.onload = function (e) {
                    annotationImage.src = e.target.result;
                    annotationImage.style.display = 'block';
                    placeholder.style.display = 'none';

                    // Clear previous annotations
                    clearAnnotations();
                };

                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadArea.style.background = '#e0e0e0';
        });

        uploadArea.addEventListener('dragleave', function () {
            uploadArea.style.background = '#f0f0f0';
        });

        uploadArea.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadArea.style.background = '#f0f0f0';

            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                imageUpload.files = e.dataTransfer.files;
                const event = new Event('change');
                imageUpload.dispatchEvent(event);
            }
        });

        // Type switching
        greatBtn.addEventListener('click', function () {
            setActiveType('great');
        });

        americanBtn.addEventListener('click', function () {
            setActiveType('american');
        });

        chileanBtn.addEventListener('click', function () {
            setActiveType('chilean');
        });

        // Image click to add annotation
        annotationImage.addEventListener('click', function (e) {
            // Get the position and actual display size of the image relative to the container
            const containerRect = imageContainer.getBoundingClientRect();
            const imgRect = annotationImage.getBoundingClientRect();

            // Calculate coordinates relative to the image
            const scaleX = annotationImage.naturalWidth / imgRect.width;
            const scaleY = annotationImage.naturalHeight / imgRect.height;

            const x = (e.clientX - imgRect.left) * scaleX;
            const y = (e.clientY - imgRect.top) * scaleY;

            // Determine if the click is on the left or right half
            const isLeft = (e.clientX - imgRect.left) < imgRect.width / 2;
            const currentLeg = isLeft ? 'left' : 'right';

            // Create annotation - now records left and right leg colors
            createAnnotation(x, y, currentLeg, leftColor, rightColor);
        });

        // Export button click event (JSON)
        exportBtn.addEventListener('click', function () {
            exportAnnotations();
        });

        // Export to Excel button click event
        exportExcelBtn.addEventListener('click', function () {
            exportToExcel();
        });

        // Clear button click event
        clearBtn.addEventListener('click', function () {
            clearAnnotations();
        });

        // Set current active type
        function setActiveType(type) {
            currentType = type;

            // Update button states
            greatBtn.classList.remove('active');
            americanBtn.classList.remove('active');
            chileanBtn.classList.remove('active');

            if (type === 'great') {
                greatBtn.classList.add('active');
            } else if (type === 'american') {
                americanBtn.classList.add('active');
            } else if (type === 'chilean') {
                chileanBtn.classList.add('active');
            }
        }

        // Create annotation - modified to record left and right leg colors
        function createAnnotation(x, y, leg, leftLegColor, rightLegColor) {
            const id = nextId++;
            const annotation = {
                id: id,
                type: currentType,
                leg: leg,
                leftLegColor: leftLegColor,
                rightLegColor: rightLegColor,
                x: (x / annotationImage.naturalWidth).toFixed(4),
                y: (y / annotationImage.naturalHeight).toFixed(4),
                timestamp: new Date().toISOString()
            };

            annotations.push(annotation);

            // Create annotation marker - use fixed color based on type
            let markerColor;
            if (currentType === 'great') markerColor = '#FF0000'; // Red
            else if (currentType === 'american') markerColor = '#0000FF'; // Blue
            else markerColor = '#FFFF00'; // Yellow

            const marker = document.createElement('div');
            marker.className = 'annotation-marker';

            // Calculate position relative to displayed image
            const imgRect = annotationImage.getBoundingClientRect();
            const scaleX = imgRect.width / annotationImage.naturalWidth;
            const scaleY = imgRect.height / annotationImage.naturalHeight;

            const displayX = x * scaleX;
            const displayY = y * scaleY;

            marker.style.left = (imgRect.left - imageContainer.getBoundingClientRect().left + displayX) + 'px';
            marker.style.top = (imgRect.top - imageContainer.getBoundingClientRect().top + displayY) + 'px';
            marker.style.backgroundColor = markerColor;
            marker.textContent = id;
            marker.dataset.id = id;

            // Add dark text for light-colored markers
            if (markerColor === '#FFFF00') {
                marker.style.color = '#000';
            } else {
                marker.style.color = '#FFF';
            }

            // Add double-click to delete event
            marker.addEventListener('dblclick', function () {
                removeAnnotation(id);
            });

            imageContainer.appendChild(marker);

            // Update annotation list
            updateAnnotationsList();

            // Update counter
            counter.textContent = annotations.length;
        }

        // Update annotation list
        function updateAnnotationsList() {
            annotationsList.innerHTML = '';

            annotations.forEach(ann => {
                const item = document.createElement('div');
                item.className = `annotation-item annotation-${ann.type}`;

                const info = document.createElement('div');
                info.className = 'annotation-info';
                info.textContent = `#${ann.id} - ${ann.type}`;

                const colorInfo = document.createElement('div');
                colorInfo.className = 'color-info';

                const leftDot = document.createElement('span');
                leftDot.className = 'color-dot';
                leftDot.style.backgroundColor = ann.leftLegColor;

                const rightDot = document.createElement('span');
                rightDot.className = 'color-dot';
                rightDot.style.backgroundColor = ann.rightLegColor;

                colorInfo.appendChild(leftDot);
                colorInfo.appendChild(rightDot);

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.addEventListener('click', function () {
                    removeAnnotation(ann.id);
                });

                item.appendChild(info);
                item.appendChild(colorInfo);
                item.appendChild(deleteBtn);
                annotationsList.appendChild(item);
            });
        }

        // Remove annotation
        function removeAnnotation(id) {
            // Remove from array
            annotations = annotations.filter(ann => ann.id !== id);

            // Remove from DOM
            const marker = document.querySelector(`.annotation-marker[data-id="${id}"]`);
            if (marker) {
                marker.remove();
            }

            // Update annotation list
            updateAnnotationsList();

            // Update counter
            counter.textContent = annotations.length;
        }

        // Clear all annotations
        function clearAnnotations() {
            if (annotations.length === 0) return;

            if (!confirm('Are you sure you want to clear all annotations? This action cannot be undone.')) return;

            annotations = [];
            nextId = 1;

            const markers = document.querySelectorAll('.annotation-marker');
            markers.forEach(marker => marker.remove());

            // Update annotation list
            updateAnnotationsList();

            counter.textContent = '0';
        }

        // Export annotation data (JSON)
        function exportAnnotations() {
            if (annotations.length === 0) {
                alert('There are no annotations to export!');
                return;
            }

            const data = {
                image: annotationImage.src.split('/').pop(), // Keep only the filename
                currentLeftColor: leftColor,
                currentRightColor: rightColor,
                annotations: annotations,
                exportedAt: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `flamingo_annotations_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            link.click();
        }

        // Export to Excel function with color display
        async function exportToExcel() {
            if (annotations.length === 0) {
                alert('There are no annotations to export!');
                return;
            }
            try {
                // Create a new workbook
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Annotations');
                // Add headers with styling
                const headerRow = worksheet.addRow([
                    'ID', 'Type', 'Leg', 'Left Leg Color', 'Right Leg Color',
                    'X Coordinate', 'Y Coordinate', 'Timestamp'
                ]);

                // Style header row
                headerRow.eachCell((cell) => {
                    cell.font = {bold: true};
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {argb: 'FFE0E0E0'}
                    };
                });
                // Add data and apply colors
                annotations.forEach(ann => {
                    const row = worksheet.addRow([
                        ann.id,
                        ann.type,
                        ann.leg,
                        ann.leftLegColor,
                        ann.rightLegColor,
                        ann.x,
                        ann.y,
                        ann.timestamp
                    ]);
                    // Apply left leg color (column D)
                    const leftColorCell = row.getCell(4);
                    leftColorCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {argb: hexToArgb(ann.leftLegColor)}
                    };
                    // Apply right leg color (column E)
                    const rightColorCell = row.getCell(5);
                    rightColorCell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: {argb: hexToArgb(ann.rightLegColor)}
                    };
                });
                // Auto-fit columns for better readability
                worksheet.columns.forEach(column => {
                    let maxLength = 0;
                    column.eachCell({includeEmpty: true}, (cell) => {
                        const columnLength = cell.value ? cell.value.toString().length : 10;
                        if (columnLength > maxLength) {
                            maxLength = columnLength;
                        }
                    });
                    column.width = maxLength < 10 ? 10 : maxLength + 2;
                });
                // Generate Excel file and download
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });

                const fileName = `flamingo_annotations_${new Date().toISOString().replace(/[:.]/g, '-')}.xlsx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel. Please check the console for details.');
            }
        }

// Helper function to convert hex color to ARGB format
        function hexToArgb(hex) {
            hex = hex.replace('#', '');

            if (hex.length === 3) {
                hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
            }

            return 'FF' + hex; // FF for full opacity
        }
    });
</script>
</body>
</html>