<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>火烈鸟脚环标注工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            padding: 10px;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 95vh;
        }

        .image-section {
            flex: 2;
            padding: 10px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .control-section {
            flex: 1;
            padding: 10px;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .upload-area {
            border: 2px dashed #aaa;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            margin-bottom: 10px;
            background: #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-area:hover {
            background: #e0e0e0;
        }

        .image-container {
            position: relative;
            margin-top: 10px;
            border: 1px solid #ddd;
            overflow: hidden;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        #annotation-image {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }

        .placeholder-text {
            color: #888;
            text-align: center;
            padding: 20px;
        }

        .type-selector {
            display: flex;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }

        .type-btn {
            flex: 1;
            padding: 10px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        #great-btn {
            background: #FF0000; /* 红色 */
        }

        #american-btn {
            background: #0000FF; /* 蓝色 */
        }

        #chilean-btn {
            background: #FFFF00; /* 黄色 */
            color: black; /* 黄色背景上使用黑色文字 */
        }

        /* 所有选中状态统一为黑框+发光 */
        .type-btn.active, .color-btn.active {
            border: 3px solid #000 !important;
            box-shadow: 0 0 10px 3px rgba(255, 255, 0, 0.8) !important;
            transform: scale(1.1);
        }

        /* 浅色按钮的选中效果 */
        .color-btn.active[data-color="#FFFFFF"],
        .color-btn.active[data-color="#FFFF00"],
        .color-btn.active[data-color="#00FFFF"],
        .color-btn.active[data-color="#FFD700"],
        .color-btn.active[data-color="#FF69B4"],
        .color-btn.active[data-color="#00CED1"],
        .color-btn.active[data-color="#7CFC00"] {
            box-shadow: 0 0 10px 3px rgba(0, 0, 0, 0.6) !important;
        }

        .color-section {
            margin-bottom: 15px;
        }

        .color-section h3 {
            margin-bottom: 5px;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .color-btn {
            height: 30px;
            border: 2px solid #ddd;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        /* 添加选中状态的加粗效果 */
        .color-btn.active {
            border-width: 4px !important;
            font-weight: bold;
        }

        .counter-display {
            padding: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: #eee;
            border-radius: 5px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .export-btn {
            background: #6c5ce7;
            color: white;
        }

        .export-btn:hover {
            background: #5b4cd8;
        }

        .clear-btn {
            background: #ff4757;
            color: white;
        }

        .clear-btn:hover {
            background: #e63c4a;
        }

        .annotations-panel {
            flex-grow: 1;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            background: white;
        }

        .annotations-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .annotations-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .annotation-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .annotation-item:hover {
            background: #e9ecef;
        }

        .annotation-great {
            border-left: 4px solid #FF0000;
        }

        .annotation-american {
            border-left: 4px solid #0000FF;
        }

        .annotation-chilean {
            border-left: 4px solid #FFFF00;
        }

        .annotation-marker {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid #000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #000;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }

        .annotation-info {
            font-size: 0.9rem;
        }

        .delete-btn {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .delete-btn:hover {
            color: #ff4757;
            transform: scale(1.2);
        }

        .color-info {
            display: flex;
            gap: 5px;
        }

        .color-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <section class="image-section">
            <div class="upload-area" id="upload-area">
                <p>点击或拖拽图片到此处上传</p>
                <input type="file" id="image-upload" accept="image/*" style="display: none;">
            </div>

            <div class="image-container">
                <img id="annotation-image" alt="上传的图片">
                <p class="placeholder-text" id="placeholder">请上传图片开始标注</p>
            </div>
        </section>

        <section class="control-section">
            <h3>火烈鸟类型</h3>
            <div class="type-selector">
                <button class="type-btn active" id="great-btn">Great</button>
                <button class="type-btn" id="american-btn">American</button>
                <button class="type-btn" id="chilean-btn">Chilean</button>
            </div>

            <div class="color-section">
                <h3>左腿颜色</h3>
                <div class="color-palette" id="left-color-palette">
                    <!-- 左腿颜色按钮将通过JS动态生成 -->
                </div>
            </div>

            <div class="color-section">
                <h3>右腿颜色</h3>
                <div class="color-palette" id="right-color-palette">
                    <!-- 右腿颜色按钮将通过JS动态生成 -->
                </div>
            </div>

            <div class="counter-display">
                标注数量: <span id="counter">0</span>
            </div>

            <div class="button-group">
                <button class="action-btn export-btn" id="export-btn">导出标注数据</button>
                <button class="action-btn clear-btn" id="clear-btn">清除所有标注</button>
            </div>

            <div class="annotations-panel">
                <div class="annotations-header">
                    <h3>标注列表</h3>
                    <span>ID-类型</span>
                </div>
                <div class="annotations-list" id="annotations-list">
                    <!-- 标注列表将通过JS动态生成 -->
                </div>
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 元素引用
            const uploadArea = document.getElementById('upload-area');
            const imageUpload = document.getElementById('image-upload');
            const annotationImage = document.getElementById('annotation-image');
            const placeholder = document.getElementById('placeholder');
            const imageContainer = document.querySelector('.image-container');
            const greatBtn = document.getElementById('great-btn');
            const americanBtn = document.getElementById('american-btn');
            const chileanBtn = document.getElementById('chilean-btn');
            const leftColorPalette = document.getElementById('left-color-palette');
            const rightColorPalette = document.getElementById('right-color-palette');
            const counter = document.getElementById('counter');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const annotationsList = document.getElementById('annotations-list');

            // 状态变量
            let currentType = 'great';
            let leftColor = '#FF0000'; // 默认左腿颜色
            let rightColor = '#0000FF'; // 默认右腿颜色
            let annotations = [];
            let nextId = 1;

            // 22种预定义颜色（包含白色）
            const colorOptions = [
                '#FFFFFF', '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF',
                '#FFA500', '#800080', '#008000', '#000080', '#800000', '#808000', '#008080',
                '#808080', '#FF6A88', '#4A90E2', '#50C878', '#FFD700', '#FF69B4', '#00CED1', '#7CFC00'
            ];

            // 初始化左腿颜色选择器
            colorOptions.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                btn.dataset.color = color;

                // 为浅色添加边框以便可见
                if (color === '#FFFFFF' || color === '#FFFF00' || color === '#00FFFF' ||
                    color === '#FFD700' || color === '#FF69B4' || color === '#00CED1' ||
                    color === '#7CFC00') {
                    btn.style.borderColor = '#666';
                }

                if (color === leftColor) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', function() {
                    document.querySelectorAll('#left-color-palette .color-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.transform = 'scale(1)';
                    });
                    btn.classList.add('active');
                    leftColor = color;
                });

                // 添加悬停效果
                btn.addEventListener('mouseenter', function() {
                    if (!btn.classList.contains('active')) {
                        btn.style.transform = 'scale(1.05)';
                        btn.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
                    }
                });

                btn.addEventListener('mouseleave', function() {
                    if (!btn.classList.contains('active')) {
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }
                });

                leftColorPalette.appendChild(btn);
            });

            // 初始化右腿颜色选择器
            colorOptions.forEach(color => {
                const btn = document.createElement('button');
                btn.className = 'color-btn';
                btn.style.backgroundColor = color;
                btn.dataset.color = color;

                // 为浅色添加边框以便可见
                if (color === '#FFFFFF' || color === '#FFFF00' || color === '#00FFFF' ||
                    color === '#FFD700' || color === '#FF69B4' || color === '#00CED1' ||
                    color === '#7CFC00') {
                    btn.style.borderColor = '#666';
                }

                if (color === rightColor) {
                    btn.classList.add('active');
                }

                btn.addEventListener('click', function() {
                    document.querySelectorAll('#right-color-palette .color-btn').forEach(b => {
                        b.classList.remove('active');
                        b.style.transform = 'scale(1)';
                    });
                    btn.classList.add('active');
                    rightColor = color;
                });

                // 添加悬停效果
                btn.addEventListener('mouseenter', function() {
                    if (!btn.classList.contains('active')) {
                        btn.style.transform = 'scale(1.05)';
                        btn.style.boxShadow = '0 0 8px rgba(0,0,0,0.3)';
                    }
                });

                btn.addEventListener('mouseleave', function() {
                    if (!btn.classList.contains('active')) {
                        btn.style.transform = 'scale(1)';
                        btn.style.boxShadow = 'none';
                    }
                });

                rightColorPalette.appendChild(btn);
            });

            // 上传区域点击事件
            uploadArea.addEventListener('click', function() {
                imageUpload.click();
            });

            // 文件选择变化事件
            imageUpload.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();

                    reader.onload = function(e) {
                        annotationImage.src = e.target.result;
                        annotationImage.style.display = 'block';
                        placeholder.style.display = 'none';

                        // 清除之前的标注
                        clearAnnotations();
                    };

                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // 拖放功能
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#e0e0e0';
            });

            uploadArea.addEventListener('dragleave', function() {
                uploadArea.style.background = '#f0f0f0';
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.style.background = '#f0f0f0';

                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    imageUpload.files = e.dataTransfer.files;
                    const event = new Event('change');
                    imageUpload.dispatchEvent(event);
                }
            });

            // 类型切换
            greatBtn.addEventListener('click', function() {
                setActiveType('great');
            });

            americanBtn.addEventListener('click', function() {
                setActiveType('american');
            });

            chileanBtn.addEventListener('click', function() {
                setActiveType('chilean');
            });

            // 图片点击添加标注
            annotationImage.addEventListener('click', function(e) {
                // 获取图片相对于容器的位置和实际显示尺寸
                const containerRect = imageContainer.getBoundingClientRect();
                const imgRect = annotationImage.getBoundingClientRect();

                // 计算点击位置相对于图片的坐标
                const scaleX = annotationImage.naturalWidth / imgRect.width;
                const scaleY = annotationImage.naturalHeight / imgRect.height;

                const x = (e.clientX - imgRect.left) * scaleX;
                const y = (e.clientY - imgRect.top) * scaleY;

                // 判断点击的是左半部分还是右半部分
                const isLeft = (e.clientX - imgRect.left) < imgRect.width / 2;
                const currentLeg = isLeft ? 'left' : 'right';

                // 创建标注 - 现在记录左右腿的颜色
                createAnnotation(x, y, currentLeg, leftColor, rightColor);
            });

            // 导出按钮点击事件
            exportBtn.addEventListener('click', function() {
                exportAnnotations();
            });

            // 清除按钮点击事件
            clearBtn.addEventListener('click', function() {
                clearAnnotations();
            });

            // 设置当前活动类型
            function setActiveType(type) {
                currentType = type;

                // 更新按钮状态
                greatBtn.classList.remove('active');
                americanBtn.classList.remove('active');
                chileanBtn.classList.remove('active');

                if (type === 'great') {
                    greatBtn.classList.add('active');
                } else if (type === 'american') {
                    americanBtn.classList.add('active');
                } else if (type === 'chilean') {
                    chileanBtn.classList.add('active');
                }
            }

            // 创建标注 - 修改为记录左右腿颜色
            function createAnnotation(x, y, leg, leftLegColor, rightLegColor) {
                const id = nextId++;
                const annotation = {
                    id: id,
                    type: currentType,
                    leg: leg,
                    leftLegColor: leftLegColor,
                    rightLegColor: rightLegColor,
                    x: (x / annotationImage.naturalWidth).toFixed(4),
                    y: (y / annotationImage.naturalHeight).toFixed(4),
                    timestamp: new Date().toISOString()
                };

                annotations.push(annotation);

                // 创建标注标记 - 根据类型使用固定颜色
                let markerColor;
                if (currentType === 'great') markerColor = '#FF0000'; // 红色
                else if (currentType === 'american') markerColor = '#0000FF'; // 蓝色
                else markerColor = '#FFFF00'; // 黄色

                const marker = document.createElement('div');
                marker.className = 'annotation-marker';

                // 计算相对于显示图片的位置
                const imgRect = annotationImage.getBoundingClientRect();
                const scaleX = imgRect.width / annotationImage.naturalWidth;
                const scaleY = imgRect.height / annotationImage.naturalHeight;

                const displayX = x * scaleX;
                const displayY = y * scaleY;

                marker.style.left = (imgRect.left - imageContainer.getBoundingClientRect().left + displayX) + 'px';
                marker.style.top = (imgRect.top - imageContainer.getBoundingClientRect().top + displayY) + 'px';
                marker.style.backgroundColor = markerColor;
                marker.textContent = id;
                marker.dataset.id = id;

                // 为浅色标注添加深色文字
                if (markerColor === '#FFFF00') {
                    marker.style.color = '#000';
                } else {
                    marker.style.color = '#FFF';
                }

                // 添加双击删除事件
                marker.addEventListener('dblclick', function() {
                    removeAnnotation(id);
                });

                imageContainer.appendChild(marker);

                // 更新标注列表
                updateAnnotationsList();

                // 更新计数器
                counter.textContent = annotations.length;
            }

            // 更新标注列表
            function updateAnnotationsList() {
                annotationsList.innerHTML = '';

                annotations.forEach(ann => {
                    const item = document.createElement('div');
                    item.className = `annotation-item annotation-${ann.type}`;

                    const info = document.createElement('div');
                    info.className = 'annotation-info';
                    info.textContent = `#${ann.id} - ${ann.type}`;

                    const colorInfo = document.createElement('div');
                    colorInfo.className = 'color-info';

                    const leftDot = document.createElement('span');
                    leftDot.className = 'color-dot';
                    leftDot.style.backgroundColor = ann.leftLegColor;

                    const rightDot = document.createElement('span');
                    rightDot.className = 'color-dot';
                    rightDot.style.backgroundColor = ann.rightLegColor;

                    colorInfo.appendChild(leftDot);
                    colorInfo.appendChild(rightDot);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.addEventListener('click', function() {
                        removeAnnotation(ann.id);
                    });

                    item.appendChild(info);
                    item.appendChild(colorInfo);
                    item.appendChild(deleteBtn);
                    annotationsList.appendChild(item);
                });
            }

            // 移除标注
            function removeAnnotation(id) {
                // 从数组中移除
                annotations = annotations.filter(ann => ann.id !== id);

                // 从DOM中移除
                const marker = document.querySelector(`.annotation-marker[data-id="${id}"]`);
                if (marker) {
                    marker.remove();
                }

                // 更新标注列表
                updateAnnotationsList();

                // 更新计数器
                counter.textContent = annotations.length;
            }

            // 清除所有标注
            function clearAnnotations() {
                if (annotations.length === 0) return;

                if (!confirm('确定要清除所有标注吗？此操作不可撤销。')) return;

                annotations = [];
                nextId = 1;

                const markers = document.querySelectorAll('.annotation-marker');
                markers.forEach(marker => marker.remove());

                // 更新标注列表
                updateAnnotationsList();

                counter.textContent = '0';
            }

            // 导出标注数据
            function exportAnnotations() {
                if (annotations.length === 0) {
                    alert('没有标注数据可导出！');
                    return;
                }

                const data = {
                    image: annotationImage.src.split('/').pop(), // 只保留文件名
                    currentLeftColor: leftColor,
                    currentRightColor: rightColor,
                    annotations: annotations,
                    exportedAt: new Date().toISOString()
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});

                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `flamingo_annotations_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                link.click();
            }
        });
    </script>
</body>
</html>